---
title: "R Notebook"
output: html_notebook
---

Author: Joss Ives, *updated by Joss Ives `r format(Sys.time(), "%Y %B %d, %H:%M:%S")`*.

# Setup

## Load libraries
```{r}
suppressWarnings(library(lme4))
require(lme4)
suppressWarnings(library(ggplot2))
require(ggplot2)
source("jossfunc.R")
```

## Data files

### Load data
```{r}
dat.raw <- read.csv("C:/Users/Joss/ownCloud/Shared/DP_Derived_Data/dpLogisticDat.csv")
```

### Set categorical variables
```{r}
dat.raw$ID        <- factor(dat.raw$ID)
dat.raw$QNUM      <- factor(dat.raw$QNUM)
dat.raw$TREATMENT <- factor(dat.raw$TREATMENT)

```

### Make some data subsets
```{r}
# Keep only those data points where TREATMENT was set
dat.all <- subset(dat.raw, TREATMENT==0 | TREATMENT==1)

# Look only at the 4 questions that had TREATMENT
dat.trt <- subset(dat.all, QNUM==5 | QNUM==6 | QNUM==9 | QNUM==10)

```



# Initial analyses on 4 EYA questions

### What do the results look like for each question?
```{r}
dodge=position_dodge(width=0.9)

corr.by.question <- summarySE(
  dat.trt, measurevar="QCORRECT", groupvars=c("TREATMENT","QNUM")
  )

limits <- aes(ymax = QCORRECT + binomial.error, ymin = QCORRECT - binomial.error)

ggplot(corr.by.question, aes(x=QNUM, y=QCORRECT, fill=TREATMENT)) +
  geom_bar(stat="identity", position=dodge) + 
  geom_errorbar(limits, position=dodge, width=0.25) +
  labs(x = "Question number", y = "Fraction correct") +
  scale_fill_discrete(labels=c("Control","Treatment")) +
  theme_bw() + 
  theme(axis.text = element_text(face = "bold")) + 
  #theme(legend.position="none")
  scale_y_continuous(limits = c(0,1)) +
  guides(fill=guide_legend(title=NULL)) 
  #ggtitle("All")
```


### Fisher's Exact for overall question set
```{r}
## fisher.2vector
# 2 vectors of 0s and 1s are passed
# * The first is control (top row)
# * The second is treatement (bottom row)
# Adding parenthesis around assigning a variable causes the output to be displayed
(result <- fisher.2vector(
  dat.trt$QCORRECT[dat.trt$TREATMENT==0],
  dat.trt$QCORRECT[dat.trt$TREATMENT==1]
)) 
cat("Cohen's d\n ", cohens.d.from.odds.simple(result$estimate[[1]]),"\n")

```

### Simple logistic regression
```{r}
m <- glmer(QCORRECT ~ QNUM + TREATMENT + (1|ID), 
                data = dat.trt, 
                family = binomial, control=glmerControl(optimizer="bobyqa"))
print(summary(m))
#
se <- sqrt(diag(vcov(m)))
tab <- cbind(Est = fixef(m), LL = fixef(m) - 1.96 * se, UL = fixef(m) + 1.96 *se)
exp(tab)
```


### A quick summary of odds ratios so far
```{r}
odds.table <- matrix(c(result$estimate[[1]],exp(tab[[5]])),ncol=1,byrow=TRUE)
colnames(odds.table) <- c("Odds Ratio")
rownames(odds.table) <- c("Fisher's Exact Test","Logistic Regression")
as.table(odds.table)
```

# Digging into the logistic regressions a bit more
```{r}
m.2re <- glmer(QCORRECT ~ (1|QNUM) + TREATMENT + (1|ID), 
                data = dat.trt, 
                family = binomial, control=glmerControl(optimizer="bobyqa"))
print(summary(m.2re))
```
