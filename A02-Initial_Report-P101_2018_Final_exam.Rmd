---
title: "A02-Initial_Report-P101_2018_Final_exam"
author: "Joss Ives"
date: "May 28, 2018"
output: html_notebook
---
*updated by Joss Ives `r format(Sys.time(), "%Y %B %d, %H:%M:%S")`*

# Overview
This report discusses the initial analysis of the W2017T2 data from the Physics 101 course. In this course, 4 questions were used to look at the effect of asking students to explain their answer after a multiple-choice question. This used a crossover protocol, where there were 2 versions of the test and each version had 2 explain your answer questions that the other group did not. 

# Setup

```{r echo=FALSE}
#
# Setup - This section is not written to the output document
#
```

```{r echo=FALSE}
# Load libraries
suppressWarnings(library(lme4))
require(lme4)
suppressWarnings(library(ggplot2))
require(ggplot2)
source("jossfunc.R")
```

```{r echo=FALSE}
# Load data
dat.raw <- read.csv("C:/Users/Joss/ownCloud/Shared/DP_Derived_Data/dpLogisticDat.csv")
```
### Add additional calculated values
```{r echo=FALSE}
dat.raw$course.grade.frac <- dat.raw$course.grade/100.
dat.raw$CRT.medsplit <- trunc(dat.raw$NCRT/2)
dat.raw$final.grade.LMH <- as.integer(
  cut(dat.raw$f.tot78, quantile(dat.raw$f.tot78, probs=0:3/3), include.lowest=TRUE)
  )
dat.raw$final.grade.fix <- (dat.raw$f.tot78-2.*dat.raw$QCORRECT)/76.
dat.raw$final.gradeA.fix <- (dat.raw$f.Atot40-2.*dat.raw$QCORRECT)/38.
```
The following is a summary of the variables present in the data file. The final 4 were caculated in this notebook. "Fix" refers to removing from the overall score on the test, the score of the specific question.
```{r}
names(dat.raw)
```

```{r echo = FALSE}
### Set categorical variables
dat.raw$ID        <- factor(dat.raw$ID)
dat.raw$QNUM      <- factor(dat.raw$QNUM)
dat.raw$TREATMENT <- factor(dat.raw$TREATMENT)

```

```{r echo=FALSE}
### Make some data subsets

# Keep only those data points where TREATMENT was set
dat.all <- subset(dat.raw, TREATMENT==0 | TREATMENT==1)

# Look only at the 4 questions that had TREATMENT
dat.all.EYA <- subset(dat.all, EYAfinal==1)

# Look only at the 4 questions that had TREATMENT
dat.trt <- subset(dat.all.EYA, QNUM==5 | QNUM==6 | QNUM==9 | QNUM==10)
```

# Data description

### How well was each question answered?


```{r echo=FALSE}
(corr.by.question <- summarySE(
  dat.trt, measurevar="QCORRECT", groupvars=c("TREATMENT","QNUM")
  ))

limits <- aes(ymax = QCORRECT + binomial.error, ymin = QCORRECT - binomial.error)

```


```{r echo=FALSE}

ggplot(corr.by.question, aes(x=QNUM, y=QCORRECT, fill=TREATMENT)) +
  geom_bar(stat="identity", position=dodge) + 
  geom_errorbar(limits, position=dodge, width=0.25) +
  labs(x = "Question number", y = "Fraction correct") +
  scale_fill_discrete(labels=c("Control","Treatment")) +
  theme_bw() + 
  theme(axis.text = element_text(face = "bold")) + 
  #theme(legend.position="none")
  scale_y_continuous(limits = c(0,1)) +
  guides(fill=guide_legend(title=NULL)) +
  ggtitle("Performance by question")
```


### Fisher's Exact for overall question set
```{r}
## fisher.2vector
# 2 vectors of 0s and 1s are passed
# * The first is control (top row)
# * The second is treatement (bottom row)
# Adding parenthesis around assigning a variable causes the output to be displayed
(result <- fisher.2vector(
  dat.trt$QCORRECT[dat.trt$TREATMENT==0],
  dat.trt$QCORRECT[dat.trt$TREATMENT==1]
)) 
cat("Cohen's d\n ", cohens.d.from.odds.simple(result$estimate[[1]]),"\n")

```

### Simple logistic regression
```{r}
m <- glmer(QCORRECT ~ QNUM + TREATMENT + (1|ID), 
                data = dat.trt, 
                family = binomial, control=glmerControl(optimizer="bobyqa"))
print(summary(m))
#
se <- sqrt(diag(vcov(m)))
tab <- cbind(Est = fixef(m), LL = fixef(m) - 1.96 * se, UL = fixef(m) + 1.96 *se)
exp(tab)
```


### A quick summary of odds ratios so far
```{r}
odds.table <- matrix(c(result$estimate[[1]],exp(tab[[5]])),ncol=1,byrow=TRUE)
colnames(odds.table) <- c("Odds Ratio")
rownames(odds.table) <- c("Fisher's Exact Test","Logistic Regression")
as.table(odds.table)
```

